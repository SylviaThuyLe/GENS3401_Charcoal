---
title: "Anthracological Assessment of Post-Settlement Soils in Fundy Provincial Park "
date: "`r format(Sys.Date())`"
author:
- Nabiha Tasnuv^1^*
- Sydney Teresa Battist^1^*
- Thuy Thi Ngoc Le^1^*

output:
  bookdown::html_document2:
    code_folding: show
    keep_md: yes
    toc: TRUE
    toc_float: TRUE
    toc_depth: 6
    fig_caption: yes
editor_options: 
  markdown: 
    wrap: 72
---
```{css, echo=FALSE}
p.caption {
  font-size: 18px;
}
```

# **ACKNOWLEDGEMENTS** {-}
Ben Phiplip
Elizabeth Stregger (data coding)
Oher group member for dendro 

# **MATERIALS & METHODS** 
## Set Chunk Options
```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, error = FALSE, message = FALSE)
knitr::opts_chunk$set(fig.path='Figs/')
```

## Load Packages
```{r packages, include = FALSE}
library(tidyverse) #core packages from Tidyverse
library(googledrive) #access to Google Drive
library(googlesheets4) #access to Google Sheets
library(lubridate) #tidyverse handling dates & times
library(knitr) #make table
library(vegan) #shannon diversity calculation
```

## Connect to Google Account
```{r connect_google}
# Deauthorize to access public sheets
gs4_deauth()

#URL of the Google Sheet so that it is available to anyone
googlesheet_url <- "https://docs.google.com/spreadsheets/d/1u14lKzqxOS3QofUmpfmVJ3RpYHt1jMNrFTxg_J5v4Qc/edit?usp=sharing"
```


## Accessing Data From Google Sheets
```{r accessing_sheets}
Diversity <- read_sheet(googlesheet_url, sheet = "Diversity")
Meter <- read_sheet(googlesheet_url, sheet = "Meter_Info")
ID <- read_sheet(googlesheet_url, sheet = "Tree_ID")
```


## Data Dictionary 
```{r data_dictionary}
DataDictionary <- read_sheet(googlesheet_url, sheet = "Data_dictionary")
kable(DataDictionary)
```



# **RESULTS**
## Diversity Calculation by Shannon Diversity Index

```{r Shanon Diversity}
# 1) Clean and prepare data
#    (expects a data frame `Diversity` with columns: Meter, Tree_species)
# =========================
diversity <- Diversity %>%
  mutate(
    meter = as.character(Meter),
    # normalize species text
    Tree_Species = str_squish(Tree_species),
    Tree_Species = str_to_title(Tree_Species)
  ) %>%
  filter(!is.na(meter), !is.na(Tree_Species), Tree_Species != "")

# ===========================================
# 2) Count abundance and make community matrix
# ===========================================
counts <- diversity %>%
  count(meter, Tree_Species, name = "abundance")

comm_mat <- counts %>%
  pivot_wider(
    names_from  = Tree_Species,
    values_from = abundance,
    values_fill = 0
  ) %>%
  column_to_rownames("meter") %>%
  as.matrix()
# ---- Helper: unbiased Simpson for an abundance vector ----
simpson_unbiased <- function(x) {
  N <- sum(x)
  if (N <= 1) return(NA_real_)
  1 - sum(x * (x - 1)) / (N * (N - 1))
}
# ===========================
# 3) OVERALL (pooled) indices
# ===========================
overall_counts      <- colSums(comm_mat)                      # totals per species
overall_S           <- specnumber(overall_counts)             # richness
overall_H           <- diversity(overall_counts, index = "shannon", base = exp(1))
overall_evenness_J  <- as.numeric(overall_H / log(overall_S)) # Pielou J'
overall_Simpson_u   <- simpson_unbiased(overall_counts)       # unbiased Simpson

overall_summary <- tibble(
  metric = c("Shannon_H", "Richness_S", "Evenness_J", "Simpson_unbiased"),
  value  = c(overall_H, overall_S, overall_evenness_J, overall_Simpson_u)
)

# ==========================================
# 4) DIVERSITY PER METER (Shannon + unbiased Simpson)
# ==========================================
H_per_meter         <- diversity(comm_mat, index = "shannon", base = exp(1))
S_per_meter         <- specnumber(comm_mat, MARGIN = 1)
J_per_meter         <- as.numeric(H_per_meter / log(pmax(S_per_meter, 1)))
Simpson_u_per_meter <- apply(comm_mat, 1, simpson_unbiased)

diversity_by_meter <- tibble(
  meter                   = rownames(comm_mat),
  Shannon_H               = as.numeric(H_per_meter),
  Richness_S              = as.integer(S_per_meter),
  Evenness_J              = J_per_meter,
  Simpson_unbiased_cal    = as.numeric(Simpson_u_per_meter)
) %>% arrange(as.numeric(meter))

# ======================================================
# 5) Species × meter: counts and proportions per meter
# ======================================================
species_by_meter_counts <- as_tibble(comm_mat, rownames = "meter")

species_by_meter_props <- species_by_meter_counts %>%
  mutate(total_at_meter = rowSums(across(-meter))) %>%
  mutate(across(-c(meter, total_at_meter),
                ~ ifelse(total_at_meter > 0, .x / total_at_meter, 0),
                .names = "{.col}_prop"))

# ============================================================
# 6) “Spatial diversity” for each species across all meters
#    (distribution of each species across meters)
# ============================================================
# Shannon spatial (meters as categories)
spatial_Shannon_by_species <- apply(comm_mat, 2, function(x){
  tot <- sum(x); if (tot == 0) return(NA_real_)
  p <- x / tot
  diversity(p, index = "shannon", base = exp(1))
})

# Unbiased Simpson spatial (using counts across meters)
spatial_Simpson_u_by_species <- apply(comm_mat, 2, simpson_unbiased)

species_spatial_summary <- tibble(
  species                   = names(spatial_Shannon_by_species),
  spatial_Shannon_H         = as.numeric(spatial_Shannon_by_species),
  spatial_Simpson_unbiased  = as.numeric(spatial_Simpson_u_by_species),
  total_abundance           = as.numeric(overall_counts)
) %>% arrange(desc(total_abundance))

# ===================
# 7) View / export
# ===================
overall_summary                 # Overall site-level indices (Shannon + unbiased Simpson)
diversity_by_meter              # Per-meter indices
species_by_meter_counts         # Counts per species per meter
species_by_meter_props          # Proportions per species per meter
species_spatial_summary         # Spatial indices per species
```

## Histogram 
```{r}
# Combine two data frames
PhysChem_combined <- bind_rows(
  PhysChemP %>% mutate(Source = "Pellet"),
  PhysChemL %>% mutate(Source = "Liquid")
)

# Plot the data
  ## scale_fill_brewer(palette = "______"): set color for the graph
  ## position = "dodge" : put the columns side-by-side
  ## binwidth = ____ : changing size of the columns
ggplot(PhysChem_combined) +
  geom_histogram(aes(x = Colony_Type, fill = Source), position = "dodge", binwidth = 1) +
  facet_grid(rows = vars(Treat_label)) +
  theme_bw() +
  scale_fill_brewer(palette = "Set2") +
  labs(
    title = "Comparison of Colony Types Between Liquid and Pellet Vermicast Outputs",
    x = "Colony_Type",
    y = "Count",
    fill = "Legend"
  )
```







